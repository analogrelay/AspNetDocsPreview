

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Middleware &mdash; ASP.NET  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/custom.css?v=6" type="text/css" />
  

  
    <link rel="top" title="ASP.NET  documentation" href="../index.html"/>
        <link rel="up" title="Fundamentals" href="index.html"/>
        <link rel="next" title="Working with Static Files" href="static-files.html"/>
        <link rel="prev" title="Application Startup" href="startup.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ASP.NET
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.asp.net/projects/api">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conceptual-overview/index.html">Conceptual Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Fundamentals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="startup.html">Application Startup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Middleware</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="static-files.html">Working with Static Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html">Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="localization.html">Globalization and localization</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-providers.html">ðŸ”§ File Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependency-injection.html">Dependency Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="environments.html">Working with Multiple Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="app-state.html">Managing Application State</a></li>
<li class="toctree-l2"><a class="reference internal" href="servers.html">Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="request-features.html">Request Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="owin.html">OWIN</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mvc/index.html">MVC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/index.html">Working with Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client-side/index.html">Client-Side Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/index.html">Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publishing/index.html">Publishing and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hosting/index.html">Guidance for Hosting Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration/index.html">Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ASP.NET</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Fundamentals</a> &raquo;</li>
      
    <li>Middleware</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/fundamentals/middleware.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
  <div class="section" id="middleware">
<span id="fundamentals-middleware"></span><h1>Middleware<a class="headerlink" href="#middleware" title="Permalink to this headline">Â¶</a></h1>
<p>By <a class="reference external" href="http://ardalis.com">Steve Smith</a> and <a class="reference external" href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<div class="contents local topic" id="sections">
<p class="topic-title first">Sections:</p>
<ul class="simple">
<li><a class="reference internal" href="#what-is-middleware" id="id2">What is middleware</a></li>
<li><a class="reference internal" href="#creating-a-middleware-pipeline-with-iapplicationbuilder" id="id3">Creating a middleware pipeline with IApplicationBuilder</a></li>
<li><a class="reference internal" href="#built-in-middleware" id="id4">Built-in middleware</a></li>
<li><a class="reference internal" href="#writing-middleware" id="id5">Writing middleware</a></li>
<li><a class="reference internal" href="#additional-resources" id="id6">Additional Resources</a></li>
</ul>
</div>
<p><a class="reference external" href="https://github.com/aspnet/Docs/tree/master/aspnet/fundamentals/middleware/sample">View or download sample code</a></p>
<div class="section" id="what-is-middleware">
<h2><a class="toc-backref" href="#id2">What is middleware</a><a class="headerlink" href="#what-is-middleware" title="Permalink to this headline">Â¶</a></h2>
<p>Middleware are software components that are assembled into an application pipeline to handle requests and responses. Each component chooses whether to pass the request on to the next component in the pipeline, and can perform certain actions before and after the next component is invoked in the pipeline. Request delegates are used to build the request pipeline. The request delegates handle each HTTP request.</p>
<p>Request delegates are configured using <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/RunExtensions/index.html">Run</a>, <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/MapExtensions/index.html?highlight=Microsoft.AspNetCore.builder.mapextensions#Microsoft.AspNetCore.Builder.MapExtensions.Map">Map</a>, and <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/UseExtensions/index.html?highlight=Microsoft.AspNetCore.builder.useextensions#Microsoft.AspNetCore.Builder.UseExtensions.Use">Use</a> extension methods on the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/IApplicationBuilder/index.html">IApplicationBuilder</a> type that is passed into the <code class="docutils literal"><span class="pre">Configure</span></code> method in the <code class="docutils literal"><span class="pre">Startup</span></code> class. An individual request delegate can be specified in-line as an anonymous method, or it can be defined in a reusable class. These reusable classes  are <cite>middleware</cite>, or <cite>middleware components</cite>. Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline, or short-circuiting the chain if appropriate.</p>
<p><a class="reference internal" href="../migration/http-modules.html"><span class="doc">Migrating HTTP Modules to Middleware</span></a> explains the difference between request pipelines in ASP.NET Core and the previous versions and provides more middleware samples.</p>
</div>
<div class="section" id="creating-a-middleware-pipeline-with-iapplicationbuilder">
<h2><a class="toc-backref" href="#id3">Creating a middleware pipeline with IApplicationBuilder</a><a class="headerlink" href="#creating-a-middleware-pipeline-with-iapplicationbuilder" title="Permalink to this headline">Â¶</a></h2>
<p>The ASP.NET request pipeline consists of a sequence of request delegates, called one after the next, as this diagram shows (the thread of execution follows the black arrows):</p>
<img alt="../_images/request-delegate-pipeline.png" src="../_images/request-delegate-pipeline.png" />
<p>Each delegate has the opportunity to perform operations before and after the next delegate. Any delegate can choose to stop passing the request on to the next delegate, and instead handle the request itself. This is referred to as short-circuiting the request pipeline, and is desirable because it allows unnecessary work to be avoided. For example, an authorization middleware might only call the next delegate if the request is authenticated; otherwise it could short-circuit the pipeline and return a &#8220;Not Authorized&#8221; response. Exception handling delegates need to be called early on in the pipeline, so they are able to catch exceptions that occur in deeper calls within the pipeline.</p>
<p>You can see an example of setting up the request pipeline in the default web site template that ships with Visual Studio 2015. The <code class="docutils literal"><span class="pre">Configure</span></code> method adds the following middleware components:</p>
<ol class="arabic simple">
<li>Error handling (for both development and non-development environments)</li>
<li>Static file server</li>
<li>Authentication</li>
<li>MVC</li>
</ol>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">,</span> <span class="n">ILoggerFactory</span> <span class="n">loggerFactory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">loggerFactory</span><span class="p">.</span><span class="n">AddConsole</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&quot;Logging&quot;</span><span class="p">));</span>
    <span class="n">loggerFactory</span><span class="p">.</span><span class="n">AddDebug</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
    <span class="p">{</span>
<span class="hll">        <span class="n">app</span><span class="p">.</span><span class="n">UseDeveloperExceptionPage</span><span class="p">();</span>
</span><span class="hll">        <span class="n">app</span><span class="p">.</span><span class="n">UseDatabaseErrorPage</span><span class="p">();</span>
</span><span class="hll">        <span class="n">app</span><span class="p">.</span><span class="n">UseBrowserLink</span><span class="p">();</span>
</span>    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
<span class="hll">        <span class="n">app</span><span class="p">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="s">&quot;/Home/Error&quot;</span><span class="p">);</span>
</span>    <span class="p">}</span>

<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">UseStaticFiles</span><span class="p">();</span>
</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">UseIdentity</span><span class="p">();</span>
</span>
    <span class="c1">// Add external authentication middleware below. To configure them please see http://go.microsoft.com/fwlink/?LinkID=532715</span>

<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">UseMvc</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span>
</span>    <span class="p">{</span>
        <span class="n">routes</span><span class="p">.</span><span class="n">MapRoute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
            <span class="n">template</span><span class="p">:</span> <span class="s">&quot;{controller=Home}/{action=Index}/{id?}&quot;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the code above (in non-development environments), <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/ExceptionHandlerExtensions/index.html">UseExceptionHandler</a> is the first middleware added to the pipeline, therefore will catch any exceptions that occur in later calls.</p>
<p>The <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/StaticFileExtensions/index.html">static file module</a> provides no authorization checks. Any files served by it, including those under <em>wwwroot</em> are publicly available. If you want to serve files based on authorization:</p>
<ol class="arabic simple">
<li>Store them outside of <em>wwwroot</em> and any directory accessible to the static file middleware.</li>
<li>Deliver them through a controller action, returning a <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Mvc/FileResult/index.html">FileResult</a> where authorization is applied.</li>
</ol>
<p>A request that is handled by the static file module will short circuit the pipeline. (see <a class="reference internal" href="static-files.html"><span class="doc">Working with Static Files</span></a>.) If the request is not handled by the static file module, it&#8217;s passed on to the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/BuilderExtensions/index.html#methods">Identity module</a>, which performs authentication. If the request is not authenticated, the pipeline is short circuited. If the request does not fail authentication, the last stage of this pipeline is called, which is the MVC framework.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The order in which you add middleware components is generally the order in which they take effect on the request, and then in reverse for the response. This can be critical to your appâ€™s security, performance and functionality. In the code above, the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/StaticFileExtensions/index.html">static file middleware</a> is called early in the pipeline so it can handle requests and short circuit without going through unnecessary components. The authentication middleware is added to the pipeline before anything that handles requests that need to be authenticated. Exception handling must be registered before other middleware components in order to catch exceptions thrown by those components.</p>
</div>
<p>The simplest possible ASP.NET application sets up a single request delegate that handles all requests. In this case, there isn&#8217;t really a request &#8220;pipeline&#8221;, so much as a single anonymous function that is called in response to every HTTP request.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The first <code class="docutils literal"><span class="pre">App.Run</span></code> delegate terminates the pipeline. In the following example, only the first delegate (&#8220;Hello, World!&#8221;) will run.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
<span class="hll">        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span>
</span>    <span class="p">});</span>

    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello, World, Again!&quot;</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>You chain multiple request delegates together; the <code class="docutils literal"><span class="pre">next</span></code> parameter represents the next delegate in the pipeline. You can terminate (short-circuit) the pipeline by <em>not</em> calling the <cite>next</cite> parameter. You can typically perform actions both before and after the next delegate, as this example demonstrates:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureLogInline</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">ILoggerFactory</span> <span class="n">loggerfactory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">loggerfactory</span><span class="p">.</span><span class="n">AddConsole</span><span class="p">(</span><span class="n">minLevel</span><span class="p">:</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">loggerfactory</span><span class="p">.</span><span class="n">CreateLogger</span><span class="p">(</span><span class="n">_environment</span><span class="p">);</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span>
</span>    <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&quot;Handling request.&quot;</span><span class="p">);</span>
<span class="hll">        <span class="k">await</span> <span class="n">next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">();</span>
</span>        <span class="n">logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&quot;Finished handling request.&quot;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
<span class="hll">        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello from &quot;</span> <span class="p">+</span> <span class="n">_environment</span><span class="p">);</span>
</span>    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Avoid modifying <code class="docutils literal"><span class="pre">HttpResponse</span></code> after invoking next, one of the next components in the pipeline may have written to the response, causing it to be sent to the client.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This <code class="docutils literal"><span class="pre">ConfigureLogInline</span></code> method is called when the application is run with an environment set to <code class="docutils literal"><span class="pre">LogInline</span></code>. Learn more about <a class="reference internal" href="environments.html"><span class="doc">Working with Multiple Environments</span></a>. We will be using variations of <code class="docutils literal"><span class="pre">Configure[Environment]</span></code> to show different options in the rest of this article. The easiest way to run the samples in Visual Studio is with the <code class="docutils literal"><span class="pre">web</span></code> command, which is configured in <em>project.json</em>. See also <a class="reference internal" href="startup.html"><span class="doc">Application Startup</span></a>.</p>
</div>
<p>In the above example, the call to <code class="docutils literal"><span class="pre">await</span> <span class="pre">next.Invoke()</span></code> will call into the next delegate <code class="docutils literal"><span class="pre">await</span> <span class="pre">context.Response.WriteAsync(&quot;Hello</span> <span class="pre">from</span> <span class="pre">&quot;</span> <span class="pre">+</span> <span class="pre">_environment);</span></code>. The client will receive the expected response (&#8220;Hello from LogInline&#8221;), and the server&#8217;s console output includes both the before and after messages:</p>
<img alt="../_images/console-loginline.png" src="../_images/console-loginline.png" />
<div class="section" id="run-map-and-use">
<span id="middleware-run-map-use"></span><h3>Run, Map, and Use<a class="headerlink" href="#run-map-and-use" title="Permalink to this headline">Â¶</a></h3>
<p>You configure the HTTP pipeline using <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/RunExtensions/index.html">Run</a>, <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/MapExtensions/index.html">Map</a>,  and <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/UseExtensions/index.html">Use</a>. The <code class="docutils literal"><span class="pre">Run</span></code> method short circuits the pipeline (that is, it will not call a <code class="docutils literal"><span class="pre">next</span></code> request delegate). Thus, <code class="docutils literal"><span class="pre">Run</span></code> should only be called at the end of your pipeline. <code class="docutils literal"><span class="pre">Run</span></code> is a convention, and some middleware components may expose their own Run[Middleware] methods that should only run at the end of the pipeline. The following two middleware are equivalent as the <code class="docutils literal"><span class="pre">Use</span></code> version doesn&#8217;t use the <code class="docutils literal"><span class="pre">next</span></code> parameter:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureEnvironmentOne</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
</span>    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello from &quot;</span> <span class="p">+</span> <span class="n">_environment</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureEnvironmentTwo</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span>
</span>    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello from &quot;</span> <span class="p">+</span> <span class="n">_environment</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/IApplicationBuilder/index.html">IApplicationBuilder</a> interface exposes a single <code class="docutils literal"><span class="pre">Use</span></code> method, so technically they&#8217;re not all <em>extension</em> methods.</p>
</div>
<p>We&#8217;ve already seen several examples of how to build a request pipeline with <code class="docutils literal"><span class="pre">Use</span></code>. <code class="docutils literal"><span class="pre">Map*</span></code> extensions are used as a convention for branching the pipeline. The current implementation supports branching based on the request&#8217;s path, or using a predicate. The <code class="docutils literal"><span class="pre">Map</span></code> extension method is used to match request delegates based on a request&#8217;s path. <code class="docutils literal"><span class="pre">Map</span></code> simply accepts a path and a function that configures a separate middleware pipeline. In the following example, any request with the base path of <code class="docutils literal"><span class="pre">/maptest</span></code> will be handled by the pipeline configured in the <code class="docutils literal"><span class="pre">HandleMapTest</span></code> method.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">HandleMapTest</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Map Test Successful&quot;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureMapping</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="s">&quot;/maptest&quot;</span><span class="p">,</span> <span class="n">HandleMapTest</span><span class="p">);</span>
</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When <code class="docutils literal"><span class="pre">Map</span></code> is used, the matched path segment(s) are removed from <code class="docutils literal"><span class="pre">HttpRequest.Path</span></code> and appended to <code class="docutils literal"><span class="pre">HttpRequest.PathBase</span></code> for each request.</p>
</div>
<p>In addition to path-based mapping, the <code class="docutils literal"><span class="pre">MapWhen</span></code> method supports predicate-based middleware branching, allowing separate pipelines to be constructed in a very flexible fashion. Any predicate of type <code class="docutils literal"><span class="pre">Func&lt;HttpContext,</span> <span class="pre">bool&gt;</span></code> can be used to map requests to a new branch of the pipeline. In the following example, a simple predicate is used to detect the presence of a query string variable <code class="docutils literal"><span class="pre">branch</span></code>:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">HandleBranch</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
<span class="hll">        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Branch used.&quot;</span><span class="p">);</span>
</span>    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureMapWhen</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">MapWhen</span><span class="p">(</span><span class="n">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s">&quot;branch&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span> <span class="n">HandleBranch</span><span class="p">);</span>
</span>
    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello from &quot;</span> <span class="p">+</span> <span class="n">_environment</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using the configuration shown above, any request that includes a query string value for <code class="docutils literal"><span class="pre">branch</span></code> will use the pipeline defined in the <code class="docutils literal"><span class="pre">HandleBranch</span></code> method (in this case, a response of &#8220;Branch used.&#8221;). All other requests (that do not define a query string value for <code class="docutils literal"><span class="pre">branch</span></code>) will be handled by the delegate defined on line 17.</p>
<p>You can also nest Maps:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s2">&quot;/level1&quot;</span><span class="p">,</span> <span class="nx">level1App</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">level1App</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s2">&quot;/level2a&quot;</span><span class="p">,</span> <span class="nx">level2AApp</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// &quot;/level1/level2a&quot;</span>
        <span class="c1">//...</span>
    <span class="p">});</span>
    <span class="nx">level1App</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s2">&quot;/level2b&quot;</span><span class="p">,</span> <span class="nx">level2BApp</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// &quot;/level1/level2b&quot;</span>
        <span class="c1">//...</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="built-in-middleware">
<h2><a class="toc-backref" href="#id4">Built-in middleware</a><a class="headerlink" href="#built-in-middleware" title="Permalink to this headline">Â¶</a></h2>
<p>ASP.NET ships with the following middleware components:</p>
<table border="1" class="docutils" id="id1">
<caption><span class="caption-text">Middleware</span><a class="headerlink" href="#id1" title="Permalink to this table">Â¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Middleware</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="../security/authentication/index.html"><span class="doc">Authentication</span></a></td>
<td>Provides authentication support.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="../security/cors.html"><span class="doc">CORS</span></a></td>
<td>Configures Cross-Origin Resource Sharing.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="diagnostics.html"><span class="doc">Diagnostics</span></a></td>
<td>Includes support for error pages and runtime information.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="routing.html"><span class="doc">Routing</span></a></td>
<td>Define and constrain request routes.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="app-state.html#id1"><span class="std std-ref">Session</span></a></td>
<td>Provides support for managing user sessions.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="static-files.html"><span class="doc">Static Files</span></a></td>
<td>Provides support for serving static files, and directory browsing.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="writing-middleware">
<span id="middleware-writing-middleware"></span><h2><a class="toc-backref" href="#id5">Writing middleware</a><a class="headerlink" href="#writing-middleware" title="Permalink to this headline">Â¶</a></h2>
<p>The <a class="reference external" href="https://github.com/Microsoft-Build-2016/CodeLabs-WebDev/tree/master/Module2-AspNetCore">CodeLabs middleware tutorial</a> provides a good introduction to writing middleware.</p>
<p>For more complex request handling functionality, the ASP.NET team recommends implementing the middleware in its own class, and exposing an <code class="docutils literal"><span class="pre">IApplicationBuilder</span></code> extension method that can be called from the <code class="docutils literal"><span class="pre">Configure</span></code> method. The simple logging middleware shown in the previous example can be converted into a middleware class that takes in the next <code class="docutils literal"><span class="pre">RequestDelegate</span></code> in its constructor and supports an <code class="docutils literal"><span class="pre">Invoke</span></code> method as shown:</p>
<div class="literal-block-wrapper container" id="requestloggermiddleware-cs">
<div class="code-block-caption"><span class="caption-text">RequestLoggerMiddleware.cs</span><a class="headerlink" href="#requestloggermiddleware-cs" title="Permalink to this code">Â¶</a></div>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">Microsoft.AspNet.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNet.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Framework.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">MiddlewareSample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RequestLoggerMiddleware</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestDelegate</span> <span class="n">_next</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>

<span class="hll">        <span class="k">public</span> <span class="nf">RequestLoggerMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span> <span class="n">next</span><span class="p">,</span> <span class="n">ILoggerFactory</span> <span class="n">loggerFactory</span><span class="p">)</span>
</span>        <span class="p">{</span>
            <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">loggerFactory</span><span class="p">.</span><span class="n">CreateLogger</span><span class="p">&lt;</span><span class="n">RequestLoggerMiddleware</span><span class="p">&gt;();</span>
        <span class="p">}</span>

<span class="hll">        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
</span>        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&quot;Handling request: &quot;</span> <span class="p">+</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&quot;Finished handling request.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The middleware follows the <a class="reference external" href="http://deviq.com/explicit-dependencies-principle/">Explicit Dependencies Principle</a> and exposes all of its dependencies in its constructor. Middleware can take advantage of the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/UseMiddlewareExtensions/index.html#meth-Microsoft.AspNetCore.Builder.UseMiddlewareExtensions.UseMiddleware&lt;TMiddleware&gt;">UseMiddleware&lt;T&gt;</a> extension to inject services directly into their constructors, as shown in the example below. Dependency injected services are automatically filled, and the extension takes a <code class="docutils literal"><span class="pre">params</span></code> array of arguments to be used for non-injected parameters.</p>
<div class="literal-block-wrapper container" id="requestloggerextensions-cs">
<div class="code-block-caption"><span class="caption-text">RequestLoggerExtensions.cs</span><a class="headerlink" href="#requestloggerextensions-cs" title="Permalink to this code">Â¶</a></div>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">RequestLoggerExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IApplicationBuilder</span> <span class="nf">UseRequestLogger</span><span class="p">(</span><span class="k">this</span> <span class="n">IApplicationBuilder</span> <span class="n">builder</span><span class="p">)</span>
    <span class="p">{</span>
<span class="hll">        <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">UseMiddleware</span><span class="p">&lt;</span><span class="n">RequestLoggerMiddleware</span><span class="p">&gt;();</span>
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Using the extension method and associated middleware class, the <code class="docutils literal"><span class="pre">Configure</span></code> method becomes very simple and readable.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureLogMiddleware</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span>
    <span class="n">ILoggerFactory</span> <span class="n">loggerfactory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">loggerfactory</span><span class="p">.</span><span class="n">AddConsole</span><span class="p">(</span><span class="n">minLevel</span><span class="p">:</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">);</span>

<span class="hll">    <span class="n">app</span><span class="p">.</span><span class="n">UseRequestLogger</span><span class="p">();</span>
</span>
    <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&quot;Hello from &quot;</span> <span class="p">+</span> <span class="n">_environment</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Although <code class="docutils literal"><span class="pre">RequestLoggerMiddleware</span></code> requires an <code class="docutils literal"><span class="pre">ILoggerFactory</span></code> parameter in its constructor, neither the <code class="docutils literal"><span class="pre">Startup</span></code> class nor the <code class="docutils literal"><span class="pre">UseRequestLogger</span></code> extension method need to explicitly supply it. Instead, it is automatically provided through dependency injection performed within <code class="docutils literal"><span class="pre">UseMiddleware&lt;T&gt;</span></code>.</p>
<p>Testing the middleware (by setting the <code class="docutils literal"><span class="pre">Hosting:Environment</span></code> environment variable to <code class="docutils literal"><span class="pre">LogMiddleware</span></code>) should result in output like the following (when using WebListener):</p>
<img alt="../_images/console-logmiddleware.png" src="../_images/console-logmiddleware.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/Builder/StaticFileExtensions/index.html#meth-Microsoft.AspNetCore.Builder.StaticFileExtensions.UseStaticFiles">UseStaticFiles</a> extension method (which creates the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/AspNetCore/StaticFiles/StaticFileMiddleware/index.html">StaticFileMiddleware</a>) also uses <code class="docutils literal"><span class="pre">UseMiddleware&lt;T&gt;</span></code>. In this case, the <code class="docutils literal"><span class="pre">StaticFileOptions</span></code> parameter is passed in, but other constructor parameters are supplied by <code class="docutils literal"><span class="pre">UseMiddleware&lt;T&gt;</span></code> and dependency injection.</p>
</div>
</div>
<div class="section" id="additional-resources">
<h2><a class="toc-backref" href="#id6">Additional Resources</a><a class="headerlink" href="#additional-resources" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/Microsoft-Build-2016/CodeLabs-WebDev/tree/master/Module2-AspNetCore">CodeLabs middleware tutorial</a></li>
<li><a class="reference external" href="https://github.com/aspnet/Docs/tree/master/aspnet/fundamentals/middleware/sample">Sample code used in this doc</a></li>
<li><a class="reference internal" href="../migration/http-modules.html"><span class="doc">Migrating HTTP Modules to Middleware</span></a></li>
<li><a class="reference internal" href="startup.html"><span class="doc">Application Startup</span></a></li>
<li><a class="reference internal" href="request-features.html"><span class="doc">Request Features</span></a></li>
</ul>
</div>
</div>



  
  <!-- Helpfulness -->
  <div id="helpful-position"></div>
  <div id="helpful" class="helpfulness-container" style="display:none;">
    <div class="helpfulness">
      <div class="helpfulness-form">
        <h2>Is this page helpful?</h2>
        <a id="helpfulness-btn-yes" href="javascript:;" class="common-btn first">Yes</a>
        <a id="helpfulness-btn-no" href="javascript:;" class="common-btn">No</a>
      </div>
      <div class="helpfulness-form-no" style="display:none;">
        <h2>Is this page helpful?</h2>
        Sorry this wasn't helpful.
        <input type="text" id="txt-helpfulness" placeholder="Please let us know why this wasn't helpful">
        <span id="helpfulness-characters-left">characters remaining</span>
        <a id="helpfulness-btn-submit" href="javascript:;" class="common-btn">Submit</a>
        <a id="helpfulness-btn-skip" href="javascript:;" class="common-btn secondary">Skip this</a>
      </div>
      <a href="javascript:;" class="helpfulness-close">âœ–</a>
      <div class="messages processing" style="display:none;">
        Sending feedback...
      </div>
      <div class="messages success" style="display:none;">
        Thank you for your feedback!
      </div>
      <div class="messages helpfulness-error" style="display:none;">
        Error during submission!
      </div>
    </div>
  </div>
  

  <!-- wedc -->
  <noscript>
    <img alt="" width="1" height="1" src="https://c.microsoft.com/trans_pixel.aspx"/>
  </noscript>

  
    <!-- disqus -->
    <button id="showComments" type="button" class="btn btn-neutral"><i class="fa fa-comment"></i> Show comments</button>
    <div id="disqus_thread"></div>
    <hr/>
  
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="static-files.html" class="btn btn-neutral float-right" title="Working with Static Files" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="startup.html" class="btn btn-neutral" title="Application Startup" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Microsoft.
      Last updated on Jun 21, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  Documentation licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/helpfulness.js?v=6"></script>
      <script type="text/javascript" src="../_static/disqus.js?v=6"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>