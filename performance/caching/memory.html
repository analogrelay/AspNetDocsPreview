

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>In Memory Caching &mdash; ASP.NET  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/custom.css?v=6" type="text/css" />
  

  
    <link rel="top" title="ASP.NET  documentation" href="../../index.html"/>
        <link rel="up" title="Caching" href="index.html"/>
        <link rel="next" title="Working with a Distributed Cache" href="distributed.html"/>
        <link rel="prev" title="Caching" href="index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ASP.NET
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.asp.net/projects/api">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conceptual-overview/index.html">Conceptual Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fundamentals/index.html">Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mvc/index.html">MVC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data/index.html">Working with Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-side/index.html">Client-Side Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/index.html">Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publishing/index.html">Publishing and Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hosting/index.html">Guidance for Hosting Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Performance</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../measuring.html">ðŸ”§ Measuring Application Performance</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Caching</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">In Memory Caching</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="distributed.html">Working with a Distributed Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="response.html">Response Caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="output.html">ðŸ”§ Output Caching</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../migration/index.html">Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ASP.NET</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Performance</a> &raquo;</li>
      
          <li><a href="index.html">Caching</a> &raquo;</li>
      
    <li>In Memory Caching</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/performance/caching/memory.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
  <div class="section" id="in-memory-caching">
<h1>In Memory Caching<a class="headerlink" href="#in-memory-caching" title="Permalink to this headline">Â¶</a></h1>
<p>By <a class="reference external" href="http://ardalis.com">Steve Smith</a></p>
<p>Caching involves keeping a copy of data in a location that can be accessed more quickly than the source
data. ASP.NET Core has rich support for caching in a variety of ways, including keeping data in memory on the
local server, which is referred to as <em>in memory caching</em>.</p>
<div class="contents local topic" id="sections">
<p class="topic-title first">Sections:</p>
<ul class="simple">
<li><a class="reference internal" href="#caching-basics" id="id2">Caching Basics</a></li>
<li><a class="reference internal" href="#configuring-in-memory-caching" id="id3">Configuring In Memory Caching</a></li>
<li><a class="reference internal" href="#reading-and-writing-to-a-memory-cache" id="id4">Reading and Writing to a Memory Cache</a></li>
<li><a class="reference internal" href="#cache-dependencies-and-callbacks" id="id5">Cache Dependencies and Callbacks</a></li>
<li><a class="reference internal" href="#other-resources" id="id6">Other Resources</a></li>
</ul>
</div>
<p><a class="reference external" href="https://github.com/aspnet/Docs/tree/master/aspnet/performance/caching/memory/sample">View or download sample code</a></p>
<div class="section" id="caching-basics">
<span id="id1"></span><h2><a class="toc-backref" href="#id2">Caching Basics</a><a class="headerlink" href="#caching-basics" title="Permalink to this headline">Â¶</a></h2>
<p>Caching can dramatically improve the performance and scalability of ASP.NET applications, by eliminating unnecessary requests to external data sources for data that changes infrequently.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Caching in all forms (in-memory or distributed, including session state) involves making a copy of data in order to optimize performance. The copied data should be considered ephemeral - it could disappear at any time. Apps should be written to not depend on cached data, but use it when available.</p>
</div>
<p>ASP.NET supports several different kinds of caches, the simplest of which is represented by the <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/Extensions/Caching/Memory/IMemoryCache/index.html">IMemoryCache</a> interface, which represents a cache stored in the memory of the local web server.</p>
<p>You should always write (and test!) your application such that it can use cached data if it&#8217;s available, but otherwise will work correctly using the underlying data source.</p>
<p>An in-memory cache is stored in the memory of a single server hosting an ASP.NET app. If an app is hosted by multiple servers in a web farm or cloud hosting environment, the servers may have different values in their local in-memory caches. Apps that will be hosted in server farms or on cloud hosting should use a <a class="reference internal" href="distributed.html"><span class="doc">distributed cache</span></a> to avoid cache consistency problems.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">A common use case for caching is data-driven navigation menus, which rarely change but are frequently read for display within an application. Caching results that do not vary often but which are requested frequently can greatly improve performance by reducing round trips to out of process data stores and unnecessary computation.</p>
</div>
</div>
<div class="section" id="configuring-in-memory-caching">
<h2><a class="toc-backref" href="#id3">Configuring In Memory Caching</a><a class="headerlink" href="#configuring-in-memory-caching" title="Permalink to this headline">Â¶</a></h2>
<p>To use an in memory cache in your ASP.NET application, add the following dependencies to your <em>project.json</em> file:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Microsoft.AspNet.IISPlatformHandler&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Microsoft.AspNet.Server.Kestrel&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span><span class="p">,</span>
<span class="hll">    <span class="s2">&quot;Microsoft.Extensions.Caching.Abstractions&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="s2">&quot;Microsoft.Extensions.Caching.Memory&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span><span class="p">,</span>
</span>    <span class="s2">&quot;Microsoft.Extensions.Logging&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Microsoft.Extensions.Logging.Console&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0-rc1-final&quot;</span>
  <span class="p">},</span>
</pre></div>
</td></tr></table></div>
<p>Caching in ASP.NET Core is a <em>service</em> that should be referenced from your application by <a class="reference internal" href="../../fundamentals/dependency-injection.html"><span class="doc">Dependency Injection</span></a>. To register the caching service and make it available within your app, add the following line to your <code class="docutils literal"><span class="pre">ConfigureServices</span></code> method in <code class="docutils literal"><span class="pre">Startup</span></code>:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="n">services</span><span class="o">.</span><span class="n">AddCaching</span><span class="p">();</span>
</span>
</pre></div>
</td></tr></table></div>
<p>You utilize caching in your app by requesting an instance of <code class="docutils literal"><span class="pre">IMemoryCache</span></code> in your controller or middleware constructor. In the sample for this article, we are using a simple middleware component to handle requests by returning customized greeting. The constructor is shown here:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">GreetingMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span> <span class="nb">next</span><span class="p">,</span>
<span class="hll">    <span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">,</span>
</span>    <span class="n">ILogger</span><span class="o">&lt;</span><span class="n">GreetingMiddleware</span><span class="o">&gt;</span> <span class="n">logger</span><span class="p">,</span>
    <span class="n">IGreetingService</span> <span class="n">greetingService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_next</span> <span class="o">=</span> <span class="nb">next</span><span class="p">;</span>
<span class="hll">    <span class="n">_memoryCache</span> <span class="o">=</span> <span class="n">memoryCache</span><span class="p">;</span>
</span>    <span class="n">_greetingService</span> <span class="o">=</span> <span class="n">greetingService</span><span class="p">;</span>
    <span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="reading-and-writing-to-a-memory-cache">
<h2><a class="toc-backref" href="#id4">Reading and Writing to a Memory Cache</a><a class="headerlink" href="#reading-and-writing-to-a-memory-cache" title="Permalink to this headline">Â¶</a></h2>
<p>The middleware&#8217;s <code class="docutils literal"><span class="pre">Invoke</span></code> method returns the cached data when it&#8217;s available.</p>
<p>There are two methods for accessing cache entries:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">Get</span></code></dt>
<dd><code class="docutils literal"><span class="pre">Get</span></code> will return the value if it exists, but otherwise returns <code class="docutils literal"><span class="pre">null</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">TryGet</span></code></dt>
<dd><code class="docutils literal"><span class="pre">TryGet</span></code> will assign the cached value to an <code class="docutils literal"><span class="pre">out</span></code> parameter and return true if the entry exists. Otherwise it returns false.</dd>
</dl>
<p>Use the <code class="docutils literal"><span class="pre">Set</span></code> method to write to the cache. <code class="docutils literal"><span class="pre">Set</span></code> accepts the key to use to look up the value, the value to be cached, and a set of <code class="docutils literal"><span class="pre">MemoryCacheEntryOptions</span></code>. The <code class="docutils literal"><span class="pre">MemoryCacheEntryOptions</span></code> allow you to specify absolute or sliding time-based cache expiration, caching priority, callbacks, and dependencies. These options are detailed below.</p>
<p>The sample code (shown below) uses the <code class="docutils literal"><span class="pre">SetAbsoluteExpiration</span></code> method on <code class="docutils literal"><span class="pre">MemoryCacheEntryOptions</span></code> to cache greetings for one minute.</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>public Task Invoke(HttpContext httpContext)
{
    string cacheKey = &quot;GreetingMiddleware-Invoke&quot;;
    string greeting;

    // try to get the cached item; null if not found
<span class="hll">    // greeting = _memoryCache.Get(cacheKey) as string;
</span>
    // alternately, TryGet returns true if the cache entry was found
<span class="hll">    if(!_memoryCache.TryGetValue(cacheKey, out greeting))
</span>    {
        // fetch the value from the source
        greeting = _greetingService.Greet(&quot;world&quot;);

        // store in the cache
<span class="hll">        _memoryCache.Set(cacheKey, greeting,
</span><span class="hll">            new MemoryCacheEntryOptions()
</span><span class="hll">            .SetAbsoluteExpiration(TimeSpan.FromMinutes(1)));
</span>        _logger.LogInformation($&quot;{cacheKey} updated from source.&quot;);
    }
    else
    {
        _logger.LogInformation($&quot;{cacheKey} retrieved from cache.&quot;);
    }

    return httpContext.Response.WriteAsync(greeting);
}


</pre></div>
</td></tr></table></div>
<p>In addition to setting an absolute expiration, a sliding expiration can be used to keep frequently requested items in the cache:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// keep item in cache as long as it is requested at least</span>
<span class="c1">// once every 5 minutes</span>
<span class="k">new</span> <span class="nf">MemoryCacheEntryOptions</span><span class="p">()</span>
  <span class="p">.</span><span class="n">SetSlidingExpiration</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="m">5</span><span class="p">))</span>
</pre></div>
</div>
<p>To avoid having frequently-accessed cache entries growing too stale (because their sliding expiration is constantly reset), you can combine absolute and sliding expirations:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// keep item in cache as long as it is requested at least</span>
<span class="c1">// once every 5 minutes...</span>
<span class="c1">// but in any case make sure to refresh it every hour</span>
<span class="k">new</span> <span class="nf">MemoryCacheEntryOptions</span><span class="p">()</span>
  <span class="p">.</span><span class="n">SetSlidingExpiration</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="m">5</span><span class="p">))</span>
  <span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromHours</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
<p>By default, an instance of <code class="docutils literal"><span class="pre">MemoryCache</span></code> will automatically manage the items stored, removing entries when necessary in response to memory pressure in the app. You can influence the way cache entries are managed by setting their <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/Extensions/Caching/Memory/CacheItemPriority/index.html">CacheItemPriority</a> when adding the item to the cache. For instance, if you have an item you want to keep in the cache unless you explicitly remove it, you would use the <code class="docutils literal"><span class="pre">NeverRemove</span></code> priority option:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// keep item in cache indefinitely unless explicitly removed</span>
<span class="k">new</span> <span class="nf">MemoryCacheEntryOptions</span><span class="p">()</span>
  <span class="p">.</span><span class="n">SetPriority</span><span class="p">(</span><span class="n">CacheItemPriority</span><span class="p">.</span><span class="n">NeverRemove</span><span class="p">))</span>
</pre></div>
</div>
<p>When you do want to explicitly remove an item from the cache, you can do so easily using the <code class="docutils literal"><span class="pre">Remove</span></code> method:</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="n">cache</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="cache-dependencies-and-callbacks">
<h2><a class="toc-backref" href="#id5">Cache Dependencies and Callbacks</a><a class="headerlink" href="#cache-dependencies-and-callbacks" title="Permalink to this headline">Â¶</a></h2>
<p>You can configure cache entries to depend on other cache entries, the file system, or programmatic tokens, evicting the entry in response to changes. You can register a callback, which will run when a cache item is evicted.</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{
    var pause = new ManualResetEvent(false);

    _memoryCache.Set(_cacheKey, _cacheItem,
        new MemoryCacheEntryOptions()
<span class="hll">        .RegisterPostEvictionCallback(
</span><span class="hll">            (key, value, reason, substate) =&gt;
</span><span class="hll">            {
</span><span class="hll">                _result = $&quot;&#39;{key}&#39;:&#39;{value}&#39; was evicted because: {reason}&quot;;
</span><span class="hll">                pause.Set();
</span><span class="hll">            }
</span>        ));

    _memoryCache.Remove(_cacheKey);

    Assert.True(pause.WaitOne(500));

<span class="hll">    Assert.Equal(&quot;&#39;key&#39;:&#39;value&#39; was evicted because: Removed&quot;, _result);
</span>}

</pre></div>
</td></tr></table></div>
<p>The callback is run on a different thread from the code that removes the item from the cache.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If the callback is used to repopulate the cache it is possible other requests for the cache will take place (and find it empty) before the callback completes, possibly resulting in several threads repopulating the cached value.</p>
</div>
<p>Possible <a class="reference external" href="https://docs.asp.net/projects/api/en/latest/autoapi/Microsoft/Extensions/Caching/Memory/EvictionReason/index.html">eviction reasons</a> are:</p>
<dl class="docutils">
<dt>None</dt>
<dd>No reason known.</dd>
<dt>Removed</dt>
<dd>The item was manually removed by a call to <code class="docutils literal"><span class="pre">Remove()</span></code></dd>
<dt>Replaced</dt>
<dd>The item was overwritten.</dd>
<dt>Expired</dt>
<dd>The item timed out.</dd>
<dt>TokenExpired</dt>
<dd>The token the item depended upon fired an event.</dd>
<dt>Capacity</dt>
<dd>The item was removed as part of the cache&#8217;s memory management process.</dd>
</dl>
<p>You can specify that one or more cache entries depend on a <code class="docutils literal"><span class="pre">CancellationTokenSource</span></code> by adding the expiration token to the <code class="docutils literal"><span class="pre">MemoryCacheEntryOptions</span></code> object. When a cached item is invalidated, call <code class="docutils literal"><span class="pre">Cancel</span></code> on the token, which will expire all of the associated cache entries (with a reason of <code class="docutils literal"><span class="pre">TokenExpired</span></code>). The following unit test demonstrates this:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span>public void CancellationTokenFiresCallback()
{
    var cts = new CancellationTokenSource();
    var pause = new ManualResetEvent(false);
    _memoryCache.Set(_cacheKey, _cacheItem,
        new MemoryCacheEntryOptions()
<span class="hll">        .AddExpirationToken(new CancellationChangeToken(cts.Token))
</span>        .RegisterPostEvictionCallback(
            (key, value, reason, substate) =&gt;
            {
                _result = $&quot;&#39;{key}&#39;:&#39;{value}&#39; was evicted because: {reason}&quot;;
                pause.Set();
            }
        ));

<span class="hll">    // trigger the token
</span>    cts.Cancel();

    Assert.True(pause.WaitOne(500));

<span class="hll">    Assert.Equal(&quot;&#39;key&#39;:&#39;value&#39; was evicted because: TokenExpired&quot;, _result);
</span>}
</pre></div>
</td></tr></table></div>
<p>Using a <code class="docutils literal"><span class="pre">CancellationTokenSource</span></code> allows multiple cache entries to all be expired without the need to create a dependency between cache entries themselves (in which case, you must ensure that the source cache entry exists before it is used as a dependency for other entries).</p>
<p>Use a cache entry link, <code class="docutils literal"><span class="pre">IEntryLink</span></code> to specify that more than one cache entry is linked to the same cancellation token and/or time-based expiration. This approach ensures that subordinate cache entries expire at the same time as related entries.</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>[Fact]
public void CacheEntryDependencies()
{
    var cts = new CancellationTokenSource();
<span class="hll">    var pause = new ManualResetEvent(false);
</span>
    using (var cacheLink = _memoryCache.CreateLinkingScope())
    {
        _memoryCache.Set(&quot;master key&quot;, &quot;some value&quot;,
            new MemoryCacheEntryOptions()
            .AddExpirationToken(new CancellationChangeToken(cts.Token)));

<span class="hll">        _memoryCache.Set(_cacheKey, _cacheItem,
</span>            new MemoryCacheEntryOptions()
            .AddEntryLink(cacheLink)
            .RegisterPostEvictionCallback(
                (key, value, reason, substate) =&gt;
                {
                    _result = $&quot;&#39;{key}&#39;:&#39;{value}&#39; was evicted because: {reason}&quot;;
                    pause.Set();
                }
<span class="hll">            ));
</span><span class="hll">    }
</span>
    // trigger the token to expire the master item
    cts.Cancel();

    Assert.True(pause.WaitOne(500));

</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When one cache entry is linked to another, it copies that entry&#8217;s expiration token and time-based expiration settings, if any. It is not expired in response to manual removal or updating of the linked entry.</p>
</div>
</div>
<div class="section" id="other-resources">
<h2><a class="toc-backref" href="#id6">Other Resources</a><a class="headerlink" href="#other-resources" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="distributed.html"><span class="doc">Working with a Distributed Cache</span></a></li>
</ul>
</div>
</div>



  
  <!-- Helpfulness -->
  <div id="helpful-position"></div>
  <div id="helpful" class="helpfulness-container" style="display:none;">
    <div class="helpfulness">
      <div class="helpfulness-form">
        <h2>Is this page helpful?</h2>
        <a id="helpfulness-btn-yes" href="javascript:;" class="common-btn first">Yes</a>
        <a id="helpfulness-btn-no" href="javascript:;" class="common-btn">No</a>
      </div>
      <div class="helpfulness-form-no" style="display:none;">
        <h2>Is this page helpful?</h2>
        Sorry this wasn't helpful.
        <input type="text" id="txt-helpfulness" placeholder="Please let us know why this wasn't helpful">
        <span id="helpfulness-characters-left">characters remaining</span>
        <a id="helpfulness-btn-submit" href="javascript:;" class="common-btn">Submit</a>
        <a id="helpfulness-btn-skip" href="javascript:;" class="common-btn secondary">Skip this</a>
      </div>
      <a href="javascript:;" class="helpfulness-close">âœ–</a>
      <div class="messages processing" style="display:none;">
        Sending feedback...
      </div>
      <div class="messages success" style="display:none;">
        Thank you for your feedback!
      </div>
      <div class="messages helpfulness-error" style="display:none;">
        Error during submission!
      </div>
    </div>
  </div>
  

  <!-- wedc -->
  <noscript>
    <img alt="" width="1" height="1" src="https://c.microsoft.com/trans_pixel.aspx"/>
  </noscript>

  
    <!-- disqus -->
    <button id="showComments" type="button" class="btn btn-neutral"><i class="fa fa-comment"></i> Show comments</button>
    <div id="disqus_thread"></div>
    <hr/>
  
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="distributed.html" class="btn btn-neutral float-right" title="Working with a Distributed Cache" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Caching" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Microsoft.
      Last updated on Jun 21, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  Documentation licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/helpfulness.js?v=6"></script>
      <script type="text/javascript" src="../../_static/disqus.js?v=6"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>